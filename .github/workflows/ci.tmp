name: boringmd

on:  # yamllint disable-line rule:truthy
  - push

jobs:

  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2


jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.6", "3.7", "3.8", "3.9", "3.10"]
        pipenv-version: ["v2022.9.8", "v2022.9.21"]
        os: [ubuntu-18.04, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pipenv"
      - name: Run image
        uses: tiagovrtr/actions-pipenv@v1
        with:
          pipenv-version: ${{ matrix.pipenv-version }}
      - name: View pipenv --help
        run: pipenv --help




















      - id: cache-venv
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-venv-${{ hashFiles('Pipfile.lock') }}
          path: ~/.local/share/virtualenvs

      - if: steps.cache-venv.outputs.cache-hit != 'true'
        run: pipenv sync --dev

      - run: pipenv run lint
      - run: pipenv run test

      - uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: true

      - run: pipenv run build "${GITHUB_REF##*/}"

      - uses: actions/upload-artifact@v4
        with:
          path: dist
          retention-days: 1

  test:
    needs: build
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - uses: actions/download-artifact@v4

      - run: pip install "$(ls *.whl)"

      - run: boringmd --version | tee version.tmp
      - run: grep -qF "${GITHUB_REF##*/}" version.tmp

      - run: boringmd ./tests/documents/smoke.md > generated.txt
      - run: cmp ./tests/documents/smoke.txt generated.txt

      - run: boringmd ./tests/documents/smoke.md --front-matter > generated.yml
      - run: cmp ./tests/documents/smoke.yml generated.yml

  github:
    if: startsWith(github.ref, 'refs/tags')
    needs: test
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: distributable

      - run: echo "DISTRIBUTABLE=$(ls *.whl)" >> $GITHUB_ENV

      - id: get_release
        uses: bruceadams/get-release@v1.2.2
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          asset_content_type: application/x-wheel+zip
          asset_name: ${{ env.DISTRIBUTABLE }}
          asset_path: ${{ env.DISTRIBUTABLE }}
          upload_url: ${{ steps.get_release.outputs.upload_url }}

  pypi:
    if: startsWith(github.ref, 'refs/tags')
    needs: test
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: distributable
          path: dist

      - uses: pypa/gh-action-pypi-publish@v1.4.1
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
